<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quáº£n lÃ½ Email Online</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<style>
body { font-family: sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
textarea, input, button { font-size: 16px; width: 90%; max-width: 340px; margin-top: 10px; padding: 12px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; }
button { background: #007bff; color: white; border: none; cursor: pointer; transition: background 0.3s; }
button:hover { background: #0056b3; }
.input-container { display: flex; gap: 10px; align-items: center; width: 90%; max-width: 340px; margin-top: 10px; }
#manualCopyButton { max-width: 60px; padding: 10px; }
#deleteListButton { background: #dc3545; }
#deleteListButton:hover { background: #a71d2a; }
#copyButton { 
    font-size: 20px; 
    padding: 18px; 
    width: 95%; 
    max-width: 380px; 
    margin-top: 30px; 
    background: #28a745;
}
#copyButton:hover { background: #1c7c31; }
</style>
</head>
<body>

<h3>ğŸ“¨ Quáº£n lÃ½ danh sÃ¡ch Email Online</h3>

<textarea id="emailListInput" placeholder="DÃ¡n email cáº§n thÃªm, má»—i email 1 dÃ²ng..."></textarea>
<button id="addListButton">â• ThÃªm Email VÃ o Danh SÃ¡ch</button>
<button id="deleteListButton">ğŸ—‘ï¸ XÃ³a Danh SÃ¡ch Email</button>

<div class="input-container">
  <input type="text" id="emailOutput" placeholder="Email sáº½ xuáº¥t hiá»‡n á»Ÿ Ä‘Ã¢y" readonly>
  <button id="manualCopyButton">ğŸ“‹</button>
</div>

<p id="count"></p>
<p id="output"></p>

<button id="copyButton">ğŸ“‹ Láº¥y & Copy Email</button>

<script>
// === Firebase Config ===
const firebaseConfig = {
  apiKey: "AIzaSyDK3Y3P-bz4jM2p_5kVqid-P7Q80sRHkfE",
  authDomain: "email-sync-tool-96986.firebaseapp.com",
  databaseURL: "https://email-sync-tool-96986-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "email-sync-tool-96986",
  storageBucket: "email-sync-tool-96986.firebasestorage.app",
  messagingSenderId: "1037617074734",
  appId: "1:1037617074734:web:769074e6da0efc030d45bf"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const emailRef = db.ref('emails');
let emailList = [];

function updateCount() {
  document.getElementById('count').textContent = `ğŸ“Š Sá»‘ email cÃ²n láº¡i: ${emailList.length}`;
}

// Copy á»•n Ä‘á»‹nh
function copyText(text) {
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(text).then(() => {
      document.getElementById('output').textContent = `âœ… ÄÃ£ copy: ${text}`;
    }).catch(() => {
      fallbackCopy(text);
    });
  } else {
    fallbackCopy(text);
  }
}

function fallbackCopy(text) {
  const textarea = document.createElement("textarea");
  textarea.value = text;
  textarea.style.position = "fixed";
  textarea.style.left = "-9999px";
  document.body.appendChild(textarea);
  textarea.focus();
  textarea.select();
  try {
    const successful = document.execCommand('copy');
    document.getElementById('output').textContent = successful ? `âœ… ÄÃ£ copy: ${text}` : 'âš ï¸ KhÃ´ng thá»ƒ copy.';
  } catch (err) {
    document.getElementById('output').textContent = 'âš ï¸ Lá»—i khi copy.';
  }
  document.body.removeChild(textarea);
}

// Load danh sÃ¡ch mail realtime
emailRef.on('value', snapshot => {
  const data = snapshot.val();
  emailList = Array.isArray(data) ? data : [];
  updateCount();
});

// ThÃªm danh sÃ¡ch mail (cÃ³ kiá»ƒm tra trÃ¹ng)
document.getElementById('addListButton').addEventListener('click', () => {
  const input = document.getElementById('emailListInput').value.trim();
  if (!input) {
    document.getElementById('output').textContent = 'âš ï¸ Vui lÃ²ng dÃ¡n danh sÃ¡ch email.';
    return;
  }

  const newEmails = input
    .split(/\r?\n|\r|\u2028/)
    .map(e => e.trim())
    .filter(e => e);

  if (newEmails.length === 0) {
    document.getElementById('output').textContent = 'âš ï¸ KhÃ´ng cÃ³ email há»£p lá»‡.';
    return;
  }

  emailRef.transaction(currentList => {
    const updatedList = currentList ? currentList.slice() : [];
    const duplicates = [];
    const added = [];

    newEmails.forEach(email => {
      if (updatedList.includes(email)) {
        duplicates.push(email);
      } else {
        updatedList.push(email);
        added.push(email);
      }
    });

    if (added.length === 0) return; // táº¥t cáº£ trÃ¹ng -> há»§y commit

    document._addedEmails = added;
    document._duplicateEmails = duplicates;

    return updatedList;
  }, (error, committed, snapshot) => {
    const added = document._addedEmails || [];
    const duplicates = document._duplicateEmails || [];

    delete document._addedEmails;
    delete document._duplicateEmails;

    if (error) {
      document.getElementById('output').textContent = 'âš ï¸ Lá»—i khi thÃªm email.';
    } else if (!committed) {
      document.getElementById('output').textContent = 'âš ï¸ Táº¥t cáº£ email Ä‘Ã£ tá»“n táº¡i, khÃ´ng thÃªm gÃ¬ cáº£.';
    } else {
      let msg = `âœ… ÄÃ£ thÃªm ${added.length} email.`;
      if (duplicates.length > 0) {
        msg += ` âš ï¸ Bá»‹ trÃ¹ng ${duplicates.length} email.`;
        // Náº¿u muá»‘n hiá»‡n cá»¥ thá»ƒ: msg += `\nEmail trÃ¹ng: ${duplicates.join(', ')}`;
      }
      document.getElementById('output').textContent = msg;
      document.getElementById('emailListInput').value = '';
      updateCount();
    }
  });
});

// XÃ³a toÃ n bá»™ danh sÃ¡ch
document.getElementById('deleteListButton').addEventListener('click', () => {
  if (!confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a toÃ n bá»™ danh sÃ¡ch email?")) return;
  emailRef.set([], (error) => {
    if (error) {
      document.getElementById('output').textContent = 'âš ï¸ Lá»—i khi xÃ³a danh sÃ¡ch.';
    } else {
      document.getElementById('output').textContent = 'âœ… ÄÃ£ xÃ³a toÃ n bá»™ danh sÃ¡ch email.';
      emailList = [];
      updateCount();
    }
  });
});

// Copy thá»§ cÃ´ng tá»« Ã´ output
document.getElementById('manualCopyButton').addEventListener('click', () => {
  const email = document.getElementById('emailOutput').value;
  if (!email) {
    document.getElementById('output').textContent = 'âš ï¸ KhÃ´ng cÃ³ email Ä‘á»ƒ copy.';
    return;
  }
  copyText(email);
});

// ===== Äáº¿m ngÆ°á»£c 5 giÃ¢y rá»“i tá»± Ä‘á»™ng copy & xÃ³a =====
let copyCountdownTimer = null;  // giá»¯ interval náº¿u cáº§n há»§y
let copyInProgress = false;     // trÃ¡nh báº¥m nhiá»u láº§n

document.getElementById('copyButton').addEventListener('click', () => {
  if (copyInProgress) return; // Ä‘ang Ä‘áº¿m, bá» qua
  copyInProgress = true;

  if (emailList.length === 0) {
    document.getElementById('output').textContent = 'âœ… Danh sÃ¡ch Ä‘Ã£ háº¿t email.';
    copyInProgress = false;
    return;
  }

  // Láº¥y ngáº«u nhiÃªn 1 pháº§n tá»­ hiá»‡n táº¡i
  const randomIndex = Math.floor(Math.random() * emailList.length);
  const fullEmail = emailList[randomIndex];
  const email = fullEmail.split('|')[0];

  // Hiá»ƒn thá»‹ ngay trÃªn Ã´ output Ä‘á»ƒ user biáº¿t email nÃ o sáº¯p copy
  document.getElementById('emailOutput').value = email;

  // Äáº¿m ngÆ°á»£c
  let countdown = 5;
  const outputEl = document.getElementById('output');
  outputEl.textContent = `â³ Äang xá»­ lÃ½... Sáº½ copy sau ${countdown} giÃ¢y.`;
  document.getElementById('copyButton').disabled = true;

  copyCountdownTimer = setInterval(() => {
    countdown--;
    if (countdown > 0) {
      outputEl.textContent = `â³ Äang xá»­ lÃ½... Sáº½ copy sau ${countdown} giÃ¢y.`;
    } else {
      clearInterval(copyCountdownTimer);
      copyCountdownTimer = null;

      // Thá»±c hiá»‡n copy
      copyText(email);

      // XÃ³a khá»i danh sÃ¡ch trÃªn Firebase *theo giÃ¡ trá»‹* (an toÃ n hÆ¡n xÃ³a theo index vÃ¬ dá»¯ liá»‡u cÃ³ thá»ƒ thay Ä‘á»•i)
      emailRef.transaction(currentList => {
        if (!Array.isArray(currentList)) return currentList;
        const idx = currentList.indexOf(fullEmail);
        if (idx > -1) currentList.splice(idx, 1);
        return currentList;
      }, (error, committed, snapshot) => {
        if (error) {
          outputEl.textContent = 'âš ï¸ Lá»—i khi xÃ³a email.';
        } else if (committed) {
          emailList = snapshot.val() || [];
          updateCount();
          // Náº¿u trÆ°á»›c Ä‘Ã³ copyText Ä‘Ã£ hiá»ƒn thá»‹ message, giá»¯ nguyÃªn; chá»‰ ghi thÃªm khi cáº§n:
          // outputEl.textContent += ' (ÄÃ£ xÃ³a khá»i danh sÃ¡ch.)';
        }
        // Re-enable button
        document.getElementById('copyButton').disabled = false;
        copyInProgress = false;
      });
    }
  }, 1000);
});
</script>
</body>
</html>
