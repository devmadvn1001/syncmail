const newEmails = input.split(/\r?\n|\r|\u2028/).map(e => e.trim()).filter(e => e);
    if (newEmails.length === 0) {
        document.getElementById('output').textContent = '⚠️ Không có email hợp lệ.';
        return;
    }

    emailRef.transaction(currentList => {
        const updatedList = currentList ? currentList.slice() : [];
        const duplicates = [];
        const added = [];

        newEmails.forEach(email => {
            if (updatedList.includes(email)) {
                duplicates.push(email);
            } else {
                updatedList.push(email);
                added.push(email);
            }
        });

        if (added.length === 0) return; // không thêm gì cả nếu tất cả đều trùng

        document._addedEmails = added;
        document._duplicateEmails = duplicates;

        return updatedList;
    }, (error, committed, snapshot) => {
        const added = document._addedEmails  [];
        const duplicates = document._duplicateEmails  [];

        delete document._addedEmails;
        delete document._duplicateEmails;

        if (error) {
            document.getElementById('output').textContent = '⚠️ Lỗi khi thêm email.';
        } else if (!committed) {
            document.getElementById('output').textContent = '⚠️ Tất cả email đã tồn tại, không thêm gì cả.';
        } else {
            let msg = ✅ Đã thêm ${added.length} email.;
            if (duplicates.length > 0) {
                msg +=  ⚠️ Bị trùng ${duplicates.length} email.;
                // Nếu muốn hiển thị danh sách email trùng thì thêm:
                // msg += \nEmail trùng: ${duplicates.join(', ')};
            }
            document.getElementById('output').textContent = msg;
            document.getElementById('emailListInput').value = '';
            updateCount();
        }
    });
});

// Xóa toàn bộ danh sách
document.getElementById('deleteListButton').addEventListener('click', () => {
    if (!confirm("Bạn có chắc muốn xóa toàn bộ danh sách email?")) return;
    emailRef.set([], (error) => {
        if (error) {
            document.getElementById('output').textContent = '⚠️ Lỗi khi xóa danh sách.';
        } else {
            document.getElementById('output').textContent = '✅ Đã xóa toàn bộ danh sách email.';
            emailList = [];
            updateCount();
        }
    });
});

// Copy thủ công
document.getElementById('manualCopyButton').addEventListener('click', () => {
    const email = document.getElementById('emailOutput').value;
    if (!email) {
        document.getElementById('output').textContent = '⚠️ Không có email để copy.';
        return;
    }
    copyText(email);
});

// Lấy & Copy 1 email + xóa
document.getElementById('copyButton').addEventListener('click', () => {
    if (emailList.length === 0) {
        document.getElementById('output').textContent = '✅ Danh sách đã hết email.';
        return;
    }
    const randomIndex = Math.floor(Math.random() * emailList.length);
    const fullEmail = emailList[randomIndex];
    const email = fullEmail.split('|')[0];

    copyText(email);

    emailRef.transaction(currentList => {
        if (!currentList) return null;
        currentList.splice(randomIndex, 1);
        return currentList;
    }, (error, committed, snapshot) => {
        if (error) {
            document.getElementById('output').textContent = '⚠️ Lỗi khi xóa email.';
        } else if (committed) {
            document.getElementById('emailOutput').value = email;
            emailList = snapshot.val() || [];
            updateCount();
        }
    });
});
</script>
</body>
</html>
